name: Deploy Staging
on:
  push:
    branches:
      - migration-ionos
jobs:
  setup_env:
    uses: ./.github/workflows/setup-env.yml
    with:
      ENVIRONMENT: staging
      TILES_URL: staging-tiles.radverkehrsatlas.de
      CACHELESS_URL: staging-cacheless.radverkehrsatlas.de
      NEXT_PUBLIC_APP_ORIGIN: https://staging.radverkehrsatlas.de
      NEXT_PUBLIC_APP_ENV: staging
      NEXT_PUBLIC_OSM_API_URL: https://master.apis.dev.openstreetmap.org/api/0.6
      APP_URL: staging.radverkehrsatlas.de
    secrets: inherit
  restart_services:
    uses: ./.github/workflows/restart-services.yml
    needs: setup_env
    with:
      ENVIRONMENT: staging
    secrets: inherit
  call-deploy-app:
    needs: restart_services
    uses: ./.github/workflows/deploy-app-ionos.yml
    with:
      ENVIRONMENT: staging
      APP_ORIGIN: http://staging.trassenscout.de
      NEXT_PUBLIC_APP_ORIGIN: http://staging.trassenscout.de
      NEXT_PUBLIC_APP_ENV: staging
      # CONFIG_CHANGED: ${{ needs.restart_services.outputs.CHANGES == 'true' }}
    secrets:
      ASSETS_BUCKET_HOST: ${{ secrets.ASSETS_BUCKET_HOST }}
      ASSETS_BUCKET_PATH: ${{ secrets.ASSETS_BUCKET_PATH }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
      SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
